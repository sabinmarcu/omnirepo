$schema: "https://moonrepo.dev/schemas/tasks.json"

fileGroups:
  configs:
    - "*.{js,json}"

  sources:
    - "src/**/*"

  buildConfig:
    - "/.config/build.config.ts"

  tests:
    - "src/**/*.spec.*"

tasks:
  fixDependsOn:
    command: "omni fix moon dependsOn"
    inputs:
      - package.json
    outputs:
      - package.json
    options:
      cache: false

  fixExports:
    command: "omni fix exports"
    inputs:
      - package.json
    outputs:
      - package.json
    options:
      cache: false
    deps:
      - "~:fixDependsOn"

  build:
    command: "unbuild"
    type: build
    deps:
      - "root:init"
      - "~:fixExports"
      - "^:build"
    inputs:
      - "@globs(sources)"
      - "@files(buildConfig)"
    outputs:
      - esm
      - cjs
    options:
      cache: true

  test:
    command: "jest"
    args:
      - --passWithNoTests
    deps:
      - "~:build"
    inputs:
      - "@globs(sources)"

  devExports:
    command: "omni fix exports"
    args:
      - --dev
    inputs:
      - package.json
    outputs:
      - package.json
    options:
      cache: false
      runInCI: false
    deps:
      - "~:fixDependsOn"

  dev:
    command: "unbuild --stub"
    deps:
      - "root:init"
      - "~:devExports"
      - "^:dev"
    inputs:
      - "@globs(sources)"
      - "@files(buildConfig)"
    outputs:
      - esm
      - cjs
    options:
      runInCI: false
      persistent: false

  testDev:
    command: "jest"
    type: test
    args:
      - --watch
    deps:
      - "~:dev"
    inputs:
      - "@globs(sources)"
    options:
      cache: false
      runInCI: false

  lint:
    command: "eslint"
    type: test
    deps:
      - "~:build"
      - eslint-config:build
    inputs:
      - "@globs(sources)"

  publish:
    command: "yarn npm publish --tolerate-republish"
    deps:
      - "~:build"
    inputs:
      - "@globs(sources)"
    options:
      runInCI: false
